<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>أذكار الصباح والمساء</title>
  <style>
    :root { --bg:#0b0c10; --card:#1f232b; --text:#e6edf3; --muted:#9aa4b2; --ring:#3ea6ff }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;place-items:center}

    .app{width:min(680px,94vw);padding:20px;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 8px;font-size:22px;text-align:center}
    .desc{margin:4px 0 14px;text-align:center;color:var(--muted);font-size:14px}

    .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;background:#2b313c;color:var(--text)}
    .btn.primary{background:#213445}
    .btn.alt{background:#2a3a44}
    .btn:active{transform:translateY(1px)}
    .pill{border:1px solid #3a4150}
    .footer{margin-top:14px;text-align:center}

    /* تمييز الوضع المحدد */
    .btn.pill.selected{
      outline:2px solid var(--ring);
      box-shadow:0 0 0 3px rgba(62,166,255,.25) inset;
    }

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;z-index:999}
    .card{position:fixed;inset:12px;display:none;z-index:1000;background:#101319;border:1px solid #2a313f;border-radius:16px;padding:18px 16px;overflow:auto}
    .card-header{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .card-title{margin:0;font-size:16px;color:#d9e2ef}
    .x{background:#2b313c;border:0;border-radius:10px;color:#e6edf3;width:40px;height:36px;cursor:pointer}
    .x:active{transform:translateY(1px)}
    .progress{font-size:12px;color:#9aa4b2}
    .text{font-size:18px;line-height:1.9;white-space:pre-wrap;margin:8px 0 10px}
    .meta{font-size:13px;color:#9aa4b2;margin-bottom:6px}
    .tap-hint{font-size:12px;color:#9aa4b2; text-align:center; margin-top:8px}

    .auto-wrap{display:none; gap:8px; align-items:center; justify-content:center; margin:8px 0 6px}
    .auto-note{font-size:12px;color:#9aa4b2}
    .auto-btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;background:#213445;color:#e6edf3}
    .auto-btn.stop{background:#402b2b}

    .nav{display:flex;gap:10px;justify-content:space-between;position:sticky;bottom:0;background:#101319;padding-top:10px}
    .nav .btn{flex:1}
    .counter{font-size:12px;color:#9aa4b2;text-align:center;margin-top:4px}

    /* رسالة إكمال 100 */
    .done-ov{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2000}
    .done-box{background:#1f232b;color:#e6edf3;border-radius:14px;padding:18px 16px;text-align:center;max-width:min(90vw,420px);box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .done-box h3{margin:0 0 6px;font-size:18px}
    .done-box p{margin:0;font-size:14px;color:#9aa4b2}
  </style>
</head>
<body>
  <main class="app">
    <h1>أذكار الصباح والمساء</h1>
    <p class="desc">اختر الوقت، ثم ابدأ. ستظهر الأذكار بطاقةً كاملة؛ اضغط داخل البطاقة للانتقال إلى التالي.</p>

    <div class="row" style="justify-content:center;margin-bottom:12px">
      <button class="btn pill selected" id="modeMorning" aria-pressed="true">أذكار الصباح</button>
      <button class="btn pill" id="modeEvening" aria-pressed="false">أذكار المساء</button>
    </div>

    <div class="row" style="justify-content:center">
      <button class="btn primary" id="start">ابدأ القراءة</button>
      <a class="btn alt" href="index.html">العودة للعداد</a>
    </div>

    <div class="footer">
      <p style="font-size:12px;color:var(--muted)">يمكنك الإيقاف والمتابعة لاحقًا — سنحفظ تقدّمك على هذا الجهاز.</p>
    </div>
  </main>

  <div class="overlay" id="overlay"></div>
  <section class="card" id="card" tabindex="0" aria-live="polite" aria-atomic="true">
    <header class="card-header">
      <div>
        <h2 class="card-title" id="cardTitle">ذكر</h2>
        <div class="progress" id="cardProgress">1 / 1</div>
      </div>
      <button class="x" id="closeCard" title="إغلاق">✕</button>
    </header>

    <article class="text" id="cardText"></article>
    <div class="meta" id="cardMeta"></div>

    <!-- Auto Tasbih (only for repeat=100) -->
    <div class="auto-wrap" id="autoWrap">
      <button class="auto-btn" id="autoBtn">بدء التسبيح التلقائي (1 ثانية × 100)</button>
      <span class="auto-note" id="autoNote">جاهز</span>
    </div>

    <div class="counter" id="repeatInfo"></div>
    <div class="tap-hint">اضغط في أي مكان للانتقال إلى التالي</div>

    <nav class="nav">
      <button class="btn" id="prevBtn" aria-label="السابق">السابق</button>
      <button class="btn primary" id="nextBtn" aria-label="التالي">التالي</button>
    </nav>
  </section>

  <script>
    'use strict';

    /* النصوص الثابتة */
    const AYAT_AL_KURSI =
`﴿اللَّهُ لَا إِلَهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ ۚ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ ۚ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ ۗ مَن ذَا الَّذِي يَشْفَعُ عِندَهُ إِلَّا بِإِذْنِهِ ۚ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ ۖ وَلَا يُحِيطُونَ بِشَيْءٍ مِّنْ عِلْمِهِ إِلَّا بِمَا شَاءَ ۚ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضَ ۖ وَلَا يَئُودُهُ حِفْظُهُمَا ۚ وَهُوَ الْعَلِيُّ الْعَظِيمُ﴾ (البقرة: 255)`;

    const IKHLAS =
`﴿قُلْ هُوَ اللَّهُ أَحَدٌ • اللَّهُ الصَّمَدُ • لَمْ يَلِدْ وَلَمْ يُولَدْ • وَلَمْ يَكُن لَّهُ كُفُوًا أَحَدٌ﴾`;
    const FALAQ =
`﴿قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ • مِن شَرِّ مَا خَلَقَ • وَمِن شَرِّ غَاسِقٍ إِذَا وَقَبَ • وَمِن شَرِّ النَّفَّاثَاتِ فِي الْعُقَدِ • وَمِن شَرِّ حَاسِدٍ إِذَا حَسَدَ﴾`;
    const NAS =
`﴿قُلْ أَعُوذُ بِرَبِّ النَّاسِ • مَلِكِ النَّاسِ • إِلَٰهِ النَّاسِ • مِن شَرِّ الْوَسْوَاسِ الْخَنَّاسِ • الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ • مِنَ الْجِنَّةِ وَالنَّاسِ﴾`;

    /* قوائم الأذكار */
    const MORNING_LIST = [
      { title:'آية الكرسي', repeat:1, text:AYAT_AL_KURSI, ref:'مرة واحدة' },
      { title:'المعوذات', repeat:3, text:`${IKHLAS}\n\n${FALAQ}\n\n${NAS}`, ref:'ثلاث مرات' },

      /* إضافات الصباح */
      { title:'أصبحنا وأصبح الملك لله...', repeat:1, text:'أصبحنا وأصبح الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير. ربِّ أسألك خيرَ ما في هذا اليوم وخيرَ ما بعده، وأعوذ بك من شرِّ ما في هذا اليوم وشرِّ ما بعده، ربِّ أعوذ بك من الكسل وسوء الكِبَر، ربِّ أعوذ بك من عذابٍ في النار وعذابٍ في القبر.', ref:'مرة واحدة' },
      { title:'اللهم إني أصبحتُ أشهد...', repeat:4, text:'اللهم إني أصبحتُ أشهدك وأشهد حملة عرشك وملائكتك وجميع خلقك أنك أنت الله لا إله إلا أنت وحدك لا شريك لك، وأن محمداً عبدُك ورسولُك.', ref:'أربع مرات' },
      { title:'حسبي الله لا إله إلا هو...', repeat:7, text:'حسبي الله لا إله إلا هو، عليه توكلتُ وهو ربُّ العرش العظيم.', ref:'سبع مرات' },
      { title:'اللهم إني أسألك العفو والعافية (المطوّل)', repeat:1, text:'اللهم إني أسألك العفوَ والعافيةَ في الدنيا والآخرة، اللهم إني أسألك العفوَ والعافيةَ في ديني ودنياي وأهلي ومالي، اللهم استر عوراتي وآمن روعاتي، اللهم احفظني من بين يديَّ ومن خلفي وعن يميني وعن شمالي ومن فوقي، وأعوذُ بعظمتك أن أُغتالَ من تحتي.', ref:'مرة واحدة' },
      { title:'اللهم عالم الغيب والشهادة...', repeat:1, text:'اللهم عالمَ الغيبِ والشهادةِ، فاطرَ السماواتِ والأرضِ، ربَّ كلِّ شيءٍ ومليكَه، أشهد أن لا إله إلا أنت، أعوذ بك من شرِّ نفسي ومن شرِّ الشيطان وشِرْكِه، وأن أقترفَ على نفسي سوءاً أو أجرَّه إلى مسلم.', ref:'مرة واحدة' },
      { title:'أصبحنا وأصبح الملك لله رب العالمين...', repeat:1, text:'أصبحنا وأصبح الملكُ لله ربِّ العالمين، اللهم إني أسألك خيرَ هذا اليوم: فتحَه ونصرَه ونورَه وبركتَه وهُداه، وأعوذ بك من شرِّ ما فيه وشرِّ ما بعده.', ref:'مرة واحدة' },
      { title:'لا إله إلا الله وحده لا شريك له (10)', repeat:10, text:'لا إله إلا الله وحده لا شريك له، له الملك وله الحمد، وهو على كل شيء قدير.', ref:'عشر مرات' },

      /* بقية قائمتك الأصلية */
      { title:'يا حي يا قيوم برحمتك أستغيث', repeat:1, text:'يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله، ولا تكلني إلى نفسي طرفة عين.', ref:'مرة واحدة' },
      { title:'اللهم بك أصبحنا...', repeat:1, text:'اللهم بك أصبحنا وبك أمسينا، وبك نحيا وبك نموت وإليك النشور.', ref:'مرة واحدة' },
      { title:'سبحان الله وبحمده، عدد خلقه...', repeat:3, text:'سبحان الله وبحمده، عدد خلقه، ورضا نفسه، وزنة عرشه، ومداد كلماته.', ref:'ثلاث مرات' },
      { title:'أعوذ بكلمات الله التامات...', repeat:3, text:'أعوذ بكلماتِ اللهِ التَّامَّاتِ من شرِّ ما خلق.', ref:'ثلاث مرات' },
      { title:'اللهم عافني في بدني...', repeat:3, text:'اللهم عافِني في بدني، اللهم عافِني في سمعي، اللهم عافِني في بصري، لا إله إلا أنت.', ref:'ثلاث مرات' },
      { title:'اللهم إني أسألك العفو والعافية...', repeat:1, text:'اللهم إني أسألك العفو والعافية في الدنيا والآخرة.', ref:'مرة واحدة' },
      { title:'اللهم ما أصبح بي من نعمة...', repeat:1, text:'اللهم ما أصبحَ بي من نعمةٍ أو بأحدٍ من خلقِك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر.', ref:'مرة واحدة' },
      { title:'بسم الله الذي لا يضر...', repeat:3, text:'بسمِ اللهِ الذي لا يضرُّ مع اسمِه شيءٌ في الأرضِ ولا في السماءِ وهو السميعُ العليم.', ref:'ثلاث مرات' },
      { title:'رضيت بالله ربًّا...', repeat:3, text:'رضيتُ بالله ربًّا، وبالإسلام دينًا، وبمحمدٍ ﷺ نبيًّا.', ref:'ثلاث مرات' },
      { title:'سبحان الله وبحمده (100 مرة صباحًا)', repeat:100, text:'سبحان الله وبحمده.', ref:'مائة مرة' },
      { title:'ربنا آتنا في الدنيا حسنة...', repeat:1, text:'رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ.', ref:'مرة واحدة' },
      { title:'سيد الاستغفار', repeat:1, text:'اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك عليَّ، وأبوء بذنبي، فاغفر لي؛ فإنه لا يغفر الذنوب إلا أنت.', ref:'مرة واحدة' },
    ];

    const EVENING_LIST = [
      { title:'آية الكرسي', repeat:1, text:AYAT_AL_KURSI, ref:'مرة واحدة' },
      { title:'المعوذات', repeat:3, text:`${IKHLAS}\n\n${FALAQ}\n\n${NAS}`, ref:'ثلاث مرات' },

      /* إضافات المساء (صيغ أمسينا/هذه الليلة) */
      { title:'أمسينا وأمسى الملك لله...', repeat:1, text:'أمسينا وأمسى الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير. ربِّ أسألك خيرَ ما في هذه الليلة وخيرَ ما بعدها، وأعوذ بك من شرِّ ما في هذه الليلة وشرِّ ما بعدها، ربِّ أعوذ بك من الكسل وسوء الكِبَر، ربِّ أعوذ بك من عذابٍ في النار وعذابٍ في القبر.', ref:'مرة واحدة' },
      { title:'اللهم إني أمسيتُ أشهد...', repeat:4, text:'اللهم إني أمسيتُ أشهدك وأشهد حملة عرشك وملائكتك وجميع خلقك أنك أنت الله لا إله إلا أنت وحدك لا شريك لك، وأن محمداً عبدُك ورسولُك.', ref:'أربع مرات' },
      { title:'حسبي الله لا إله إلا هو...', repeat:7, text:'حسبي الله لا إله إلا هو، عليه توكلتُ وهو ربُّ العرش العظيم.', ref:'سبع مرات' },
      { title:'اللهم إني أسألك العفو والعافية (المطوّل)', repeat:1, text:'اللهم إني أسألك العفوَ والعافيةَ في الدنيا والآخرة، اللهم إني أسألك العفوَ والعافيةَ في ديني ودنياي وأهلي ومالي، اللهم استر عوراتي وآمن روعاتي، اللهم احفظني من بين يديَّ ومن خلفي وعن يميني وعن شمالي ومن فوقي، وأعوذُ بعظمتك أن أُغتالَ من تحتي.', ref:'مرة واحدة' },
      { title:'اللهم عالم الغيب والشهادة...', repeat:1, text:'اللهم عالمَ الغيبِ والشهادةِ، فاطرَ السماواتِ والأرضِ، ربَّ كلِّ شيءٍ ومليكَه، أشهد أن لا إله إلا أنت، أعوذ بك من شرِّ نفسي ومن شرِّ الشيطان وشِرْكِه، وأن أقترفَ على نفسي سوءاً أو أجرَّه إلى مسلم.', ref:'مرة واحدة' },
      { title:'أمسينا وأمسى الملك لله رب العالمين...', repeat:1, text:'أمسينا وأمسى الملكُ لله ربِّ العالمين، اللهم إني أسألك خيرَ هذه الليلة: فتحَها ونصرَها ونورَها وبركتَها وهُداها، وأعوذ بك من شرِّ ما فيها وشرِّ ما بعدها.', ref:'مرة واحدة' },
      { title:'لا إله إلا الله وحده لا شريك له (10)', repeat:10, text:'لا إله إلا الله وحده لا شريك له، له الملك وله الحمد، وهو على كل شيء قدير.', ref:'عشر مرات' },

      /* بقية قائمتك الأصلية */
      { title:'يا حي يا قيوم برحمتك أستغيث', repeat:1, text:'يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله، ولا تكلني إلى نفسي طرفة عين.', ref:'مرة واحدة' },
      { title:'اللهم بك أمسينا...', repeat:1, text:'اللهم بك أمسينا وبك أصبحنا، وبك نحيا وبك نموت وإليك المصير.', ref:'مرة واحدة' },
      { title:'سبحان الله وبحمده، عدد خلقه...', repeat:3, text:'سبحان الله وبحمده، عدد خلقه، ورضا نفسه، وزنة عرشه، ومداد كلماته.', ref:'ثلاث مرات' },
      { title:'أعوذ بكلمات الله التامات...', repeat:3, text:'أعوذ بكلماتِ اللهِ التَّامَّاتِ من شرِّ ما خلق.', ref:'ثلاث مرات' },
      { title:'اللهم عافني في بدني...', repeat:3, text:'اللهم عافِني في بدني، اللهم عافِني في سمعي، اللهم عافِني في بصري، لا إله إلا أنت.', ref:'ثلاث مرات' },
      { title:'اللهم إني أسألك العفو والعافية...', repeat:1, text:'اللهم إني أسألك العفو والعافية في الدنيا والآخرة.', ref:'مرة واحدة' },
      { title:'اللهم ما أمسى بي من نعمة...', repeat:1, text:'اللهم ما أمسى بي من نعمةٍ أو بأحدٍ من خلقِك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر.', ref:'مرة واحدة' },
      { title:'بسم الله الذي لا يضر...', repeat:3, text:'بسمِ اللهِ الذي لا يضرُّ مع اسمِه شيءٌ في الأرضِ ولا في السماءِ وهو السميعُ العليم.', ref:'ثلاث مرات' },
      { title:'رضيت بالله ربًّا...', repeat:3, text:'رضيتُ بالله ربًّا، وبالإسلام دينًا، وبمحمدٍ ﷺ نبيًّا.', ref:'ثلاث مرات' },
      { title:'سبحان الله وبحمده (100 مرة مساءً)', repeat:100, text:'سبحان الله وبحمده.', ref:'مائة مرة — «غُفرت خطاياه ولو كانت مثل زبد البحر»' },
      { title:'ربنا آتنا في الدنيا حسنة...', repeat:1, text:'رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ.', ref:'مرة واحدة' },
      { title:'سيد الاستغفار', repeat:1, text:'اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك عليَّ، وأبوء بذنبي، فاغفر لي؛ فإنه لا يغفر الذنوب إلا أنت.', ref:'مرة واحدة' },
    ];

    /* DOM مختصر */
    const $ = s => document.querySelector(s);
    const overlay = $('#overlay');
    const card = $('#card');
    const titleEl = $('#cardTitle');
    const textEl = $('#cardText');
    const metaEl = $('#cardMeta');
    const progressEl = $('#cardProgress');
    const repeatInfo = $('#repeatInfo');
    const nextBtn = $('#nextBtn');
    const prevBtn = $('#prevBtn');
    const closeBtn = $('#closeCard');
    const modeMorningBtn = $('#modeMorning');
    const modeEveningBtn = $('#modeEvening');
    const startBtn = $('#start');

    // التسبيح التلقائي
    const autoWrap = $('#autoWrap');
    const autoBtn  = $('#autoBtn');
    const autoNote = $('#autoNote');
    let autoTimer = null;

    const LS_KEY = 'adhkar.progress.v1';
    let mode = 'morning';
    let list = MORNING_LIST;
    let i = 0;
    let rep = 1;

    function setMode(newMode){
      stopAuto();
      mode = newMode;
      list = (mode === 'morning') ? MORNING_LIST : EVENING_LIST;

      const morningActive = (mode === 'morning');
      modeMorningBtn.classList.toggle('alt', !morningActive);
      modeEveningBtn.classList.toggle('alt', morningActive);
      modeMorningBtn.classList.toggle('selected', morningActive);
      modeEveningBtn.classList.toggle('selected', !morningActive);
      modeMorningBtn.setAttribute('aria-pressed', morningActive ? 'true' : 'false');
      modeEveningBtn.setAttribute('aria-pressed', !morningActive ? 'true' : 'false');

      i = 0; rep = 1; saveProgress();
    }
    function saveProgress(){ try{ localStorage.setItem(LS_KEY, JSON.stringify({mode,i,rep})); }catch{} }
    function loadProgress(){
      try{
        const d=JSON.parse(localStorage.getItem(LS_KEY));
        if(!d) return;
        setMode(d.mode==='evening'?'evening':'morning');
        i=Math.min(Math.max(0,d.i|0), list.length-1);
        rep=Math.min(Math.max(1,d.rep|0), (list[i].repeat||1));
      }catch{}
    }

    function renderCard(){
      const item = list[i];
      const t = (item.title||'').trim();
      const x = (item.text||'').trim();
      const hideTitle = t && x && x.replace(/\s+/g,' ').startsWith(t.replace(/\s+/g,' '));

      titleEl.textContent = t || 'ذكر';
      titleEl.style.display = hideTitle ? 'none' : '';

      textEl.textContent = item.text || '';
      metaEl.textContent = item.ref || '';
      progressEl.textContent = `${i+1} / ${list.length}`;

      const total = item.repeat || 1;
      repeatInfo.textContent = total>1 ? `التكرار: ${rep} / ${total}` : '';

      prevBtn.disabled = (i===0 && rep===1);
      nextBtn.textContent = (i===list.length-1 && rep===total) ? 'إنهاء' : 'التالي';

      if(total===100){
        autoWrap.style.display='flex';
        autoNote.textContent = autoTimer ? `يعمل… (${rep}/100)` : 'جاهز';
        autoBtn.textContent  = autoTimer ? 'إيقاف التسبيح التلقائي' : 'بدء التسبيح التلقائي (1 ثانية × 100)';
        autoBtn.classList.toggle('stop', !!autoTimer);
      } else {
        stopAuto();
        autoWrap.style.display='none';
      }
    }

    function next(){
      const item=list[i], total=item.repeat||1;
      if(rep<total){ rep++; }
      else{
        stopAuto();
        if(i<list.length-1){ i++; rep=1; }
        else{ alert('تمت أذكار هذا الوقت. تقبل الله.'); closeCard(); return; }
      }
      saveProgress(); renderCard();
    }
    function prev(){
      stopAuto();
      if(rep>1){ rep--; }
      else if(i>0){ i--; rep=list[i].repeat||1; }
      saveProgress(); renderCard();
    }

    function nextButton(){
      const total=(list[i].repeat||1);
      if(total===100){
        stopAuto();
        if(i<list.length-1){ i++; rep=1; saveProgress(); renderCard(); }
        else{ alert('تمت أذكار هذا الوقت. تقبل الله.'); closeCard(); }
      } else {
        next();
      }
    }
    function prevButton(){
      const total=(list[i].repeat||1);
      if(total===100){
        stopAuto();
        if(i>0){ i--; rep=list[i].repeat||1; saveProgress(); renderCard(); }
      } else {
        prev();
      }
    }

    function openCard(){ overlay.style.display='block'; card.style.display='block'; renderCard(); setTimeout(()=>card.focus(),0); }
    function closeCard(){ stopAuto(); overlay.style.display='none'; card.style.display='none'; }

    function showDoneMessage(){
      const ov=document.createElement('div');
      ov.className='done-ov';
      const box=document.createElement('div');
      box.className='done-box';
      box.innerHTML='<h3>اكتمل العدد (100)</h3><p>انقر في أي مكان لإغلاق هذه الرسالة.</p>';
      ov.appendChild(box);
      ov.addEventListener('click', ()=>{ document.body.removeChild(ov); }, {once:true});
      document.body.appendChild(ov);
    }

    function startAuto(){
      if(autoTimer) return;
      const total=(list[i].repeat||1);
      if(total!==100) return;
      autoTimer=setInterval(()=>{
        if(rep<total){
          rep++;
          autoNote.textContent=`يعمل… (${rep}/100)`;
          repeatInfo.textContent=`التكرار: ${rep} / ${total}`;
        }else{
          clearInterval(autoTimer); autoTimer=null;
          showDoneMessage();
          autoNote.textContent='اكتمل (100/100)';
          autoBtn.textContent='بدء التسبيح التلقائي (1 ثانية × 100)';
          autoBtn.classList.remove('stop');
        }
      },1000);
      renderCard();
    }
    function stopAuto(){
      if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
      if(list && list[i]){
        const total=list[i].repeat||1;
        if(total===100){
          autoNote.textContent='موقوف';
          autoBtn.textContent='بدء التسبيح التلقائي (1 ثانية × 100)';
          autoBtn.classList.remove('stop');
        }
      }
    }
    autoBtn.addEventListener('click', ()=>{ if(autoTimer) stopAuto(); else startAuto(); renderCard(); });

    /* الأحداث */
    modeMorningBtn.addEventListener('click', ()=> setMode('morning'));
    modeEveningBtn.addEventListener('click', ()=> setMode('evening'));
    startBtn.addEventListener('click', openCard);
    closeBtn.addEventListener('click', closeCard);

    nextBtn.addEventListener('click', nextButton);
    prevBtn.addEventListener('click', prevButton);

    card.addEventListener('click', (e)=>{
      if (e.target.closest('.auto-wrap, .nav, header, button')) return;
      next();
    });

    card.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowRight' || e.key==='Enter' || e.key===' '){ e.preventDefault(); nextButton(); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); prevButton(); }
      if(e.key==='Escape'){ e.preventDefault(); closeCard(); }
    });

    (function(){ setMode('morning'); loadProgress(); })();
  </script>
</body>
</html>
