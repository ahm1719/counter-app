<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ø¹Ø¯Ø§Ø¯</title>
  <style>
    :root { --bg:#0b0c10; --card:#1f232b; --text:#e6edf3; --muted:#9aa4b2; --track:#2e3440; --ring:#3ea6ff; --danger:#ff6b6b }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;place-items:center}
    .app{width:min(560px,92vw);padding:20px;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .title{margin:0 0 12px;font-weight:700;letter-spacing:.2px;font-size:clamp(18px,2.6vw,22px);text-align:center}

    .ring-wrap{position:relative;width:220px;height:220px;margin:6px auto 8px}
    .count{position:absolute;inset:0;display:grid;place-items:center;font-size:48px;font-weight:800}
    .eta{margin:-2px auto 10px;text-align:center;font-size:14px;color:var(--muted)}

    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0 8px}
    .controls.preset{grid-template-columns:1fr;gap:10px}
    button{appearance:none;border:0;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;background:#2b313c;color:var(--text);transition:transform .04s ease,background .2s ease}
    button:active{transform:translateY(1px)}
    .start{background:#213445}.stop{background:#402b2b}.reset{background:#2b3b2c}
    .preset-btn{background:#32424c}
    .preset-btn.active{outline:2px solid var(--ring);background:#2a3a44}
    .start.active{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(62,166,255,.25) inset}

    .rows{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px}
    .field{background:#2b313c;padding:10px 12px;border-radius:12px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #39414f;background:#222730;color:var(--text);font-size:16px}
    dialog{background:#1f232b;border:none;border-radius:10px;padding:20px;color:var(--text)}
    dialog input,dialog select{width:100%;margin-bottom:10px;padding:8px;border-radius:8px;border:1px solid #39414f;background:#222730;color:var(--text)}
    menu{display:flex;justify-content:space-between}

    /* inline error banner (shows if any JS error occurs) */
    #err{position:fixed;inset:auto 8px 8px 8px;background:#2b1f20;color:#ffd7d7;border:1px solid #5a2b2e;padding:10px 12px;border-radius:10px;display:none;z-index:9999}
    #err b{color:#ffb3b3}
  </style>
</head>
<body>
  <main class="app" role="application" aria-label="Ø¹Ø¯Ø§Ø¯ Ø¨Ø³ÙŠØ·">
    <h1 class="title">Ø§Ù„Ø¹Ø¯Ø§Ø¯</h1>

    <div class="ring-wrap" aria-live="polite" aria-atomic="true">
      <svg width="220" height="220" viewBox="0 0 220 220" aria-hidden="true">
        <circle cx="110" cy="110" r="96" stroke="var(--track)" stroke-width="12" fill="none"></circle>
        <circle id="prog" cx="110" cy="110" r="96" stroke="var(--ring)" stroke-width="12" fill="none"
                stroke-linecap="round" transform="rotate(-90 110 110)" stroke-dasharray="603.185" stroke-dashoffset="603.185"></circle>
      </svg>
      <div class="count"><span id="count">0</span></div>
    </div>
    <div class="eta">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="etaText">â€”</span></div>

    <div class="controls">
      <button class="start" id="startBtn">Ø¨Ø¯Ø¡</button>
      <button class="stop" id="stopBtn">Ø¥ÙŠÙ‚Ø§Ù</button>
      <button class="reset" id="resetBtn">ØªØµÙ€ÙÙŠØ±</button>
    </div>

    <div class="rows">
      <div class="field">
        <label for="interval">Ø§Ù„ÙØ§ØµÙ„ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ</label>
        <select id="interval"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
      </div>
      <div class="field">
        <label for="limit">Ø§Ù„Ø­Ø¯ (0 = Ø¨Ø¯ÙˆÙ† Ø­Ø¯)</label>
        <select id="limit"><option value="0">0</option><option>10</option><option>20</option><option>30</option><option>40</option><option>50</option><option>60</option><option>70</option><option>80</option><option>90</option><option>100</option><option>110</option><option>120</option></select>
      </div>
    </div>

    <div class="controls preset" id="customPresets"></div>
    <button class="preset-btn" id="addPresetBtn">Ø¥Ø¶Ø§ÙØ©</button>

    <div class="controls preset" style="margin-top:12px">
      <button class="preset-btn" id="presetA">Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ Ùˆ Ø¨Ø­Ù…Ø¯Ù‡</button>
      <button class="preset-btn" id="preset1">Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†Øª Ø³Ø¨Ø­Ø§Ù†Ùƒ Ø¥Ù†ÙŠ ÙƒÙ†Øª Ù…Ù† Ø§Ù„Ø¸Ø§Ù„Ù…ÙŠÙ†</button>
      <button class="preset-btn" id="preset2">Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±</button>
    </div>
  </main>

  <dialog id="cpDialog">
    <form method="dialog">
      <label>Ø§Ù„Ù†Øµ<input id="cpLabel" type="text"></label>
      <label>Ø§Ù„ÙØ§ØµÙ„<select id="cpInterval"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select></label>
      <label>Ø§Ù„Ø­Ø¯<select id="cpLimit"><option value="0">0</option><option>10</option><option>20</option><option>30</option><option>40</option><option>50</option><option>60</option><option>70</option><option>80</option><option>90</option><option>100</option><option>110</option><option>120</option></select></label>
      <menu>
        <button id="cpCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="cpSave">Ø­ÙØ¸</button>
      </menu>
    </form>
  </dialog>

  <div id="err"></div>

  <script>
    'use strict';

    // Error banner to surface runtime issues (helps debugging on mobile)
    (function(){
      const $e = document.getElementById('err');
      window.addEventListener('error', (ev)=>{
        if(!$e) return;
        $e.style.display='block';
        $e.innerHTML = '<b>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª:</b> ' + (ev.message||'') +
                       (ev.filename? ' <small>(' + ev.filename.split('/').pop() + ':' + ev.lineno + ')</small>' : '');
        console.error(ev.error||ev.message);
      });
    })();

    // --- state ---
    let running=false,count=0,intervalSec=3,limit=100,lastAccountedMs=null,remainderMs=0;

    // --- elements ---
    const $count=document.getElementById('count');
    const $prog=document.getElementById('prog');
    const $interval=document.getElementById('interval');
    const $limit=document.getElementById('limit');
    const $start=document.getElementById('startBtn');
    const $stop=document.getElementById('stopBtn');
    const $reset=document.getElementById('resetBtn');
    const $presetA=document.getElementById('presetA');
    const $preset1=document.getElementById('preset1');
    const $preset2=document.getElementById('preset2');
    const $eta=document.getElementById('etaText');
    const customWrap=document.getElementById('customPresets');

    if(!$count||!$prog||!$interval||!$limit||!$start||!$stop||!$reset||!$presetA||!$preset1||!$preset2||!$eta||!customWrap){
      const m='Element binding failed';
      console.error(m); const e=document.getElementById('err'); if(e){e.style.display='block'; e.textContent=m;}
    }

    // ring helpers
    const C=2*Math.PI*96; $prog.setAttribute('stroke-dasharray',String(C));
    function drawProgress(f){ const o=C*(1-Math.max(0,Math.min(1,f))); $prog.setAttribute('stroke-dashoffset',String(o)); }
    function updateLabel(){ $count.textContent=String(count); }

    // ETA helpers
    function formatDuration(ms){
      if(ms==null) return 'Ø¨Ø¯ÙˆÙ† Ø­Ø¯';
      let total=Math.max(0,Math.round(ms/1000));
      const h=Math.floor(total/3600); total%=3600;
      const m=Math.floor(total/60); const s=total%60;
      if(h>0) return `${h} Ø³ ${m} Ø¯`;
      if(m>0 && s===0) return `${m} Ø¯`;
      if(m>0) return `${m} Ø¯ ${s} Ø«`;
      return `${s} Ø«`;
    }
    function computeRemainingMs(){
      if(limit<=0) return null;
      const iv=intervalSec*1000;
      const remainingTicks=Math.max(0,limit-count);
      let ms=remainingTicks*iv - remainderMs;
      return Math.max(0,ms);
    }
    function refreshETA(){ const ms=computeRemainingMs(); $eta.textContent = formatDuration(ms); }

    // main loop
    let rafId=null;
    function loop(){
      if(!running){ rafId=null; return; }
      const n=Date.now(); if(lastAccountedMs==null) lastAccountedMs=n;
      let d=n-lastAccountedMs; if(d<0) d=0; lastAccountedMs=n;
      const iv=intervalSec*1000; remainderMs+=d;
      const t=Math.floor(remainderMs/iv); remainderMs%=iv;
      if(t>0){
        if(limit>0){
          const remaining=Math.max(0,limit-count);
          const applied=Math.min(remaining,t);
          count+=applied;
          if(count>=limit){
            running=false; remainderMs=0; drawProgress(0); updateLabel(); refreshETA();
            $start.classList.remove('active'); alert(`ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯: ${limit}`); return;
          }
        } else { count+=t; }
        updateLabel();
      }
      drawProgress(remainderMs/iv);
      refreshETA();
      rafId=requestAnimationFrame(loop);
    }

    // Start with 3-button modal at limit (Reset / Continue / Cancel)
    function start(){
      if(running) return;

      intervalSec=Math.min(10,Math.max(1,parseInt($interval.value||'1',10)));
      limit=Math.max(0,parseInt($limit.value||'0',10)||0);

      if(limit>0 && count>=limit){
        // Build a simple overlay modal
        const overlay=document.createElement('div');
        overlay.style.position='fixed';
        overlay.style.inset='0';
        overlay.style.background='rgba(0,0,0,0.6)';
        overlay.style.display='grid';
        overlay.style.placeItems='center';
        overlay.style.zIndex='10000';

        const box=document.createElement('div');
        box.style.background='#1f232b';
        box.style.padding='20px';
        box.style.borderRadius='12px';
        box.style.textAlign='center';
        box.style.color='white';
        box.style.width='min(320px,90vw)';
        box.innerHTML='<p style="margin-bottom:14px;font-size:15px">Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯</p>';

        const btnReset=document.createElement('button');
        btnReset.textContent='ØªØµÙÙŠØ± ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯';
        btnReset.style.margin='6px';
        btnReset.style.padding='10px 12px';
        btnReset.style.border='0';
        btnReset.style.borderRadius='8px';
        btnReset.style.background='#213445';
        btnReset.style.color='white';
        btnReset.style.cursor='pointer';
        btnReset.style.width='100%';

        const btnContinue=document.createElement('button');
        btnContinue.textContent='Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø¯';
        btnContinue.style.margin='6px';
        btnContinue.style.padding='10px 12px';
        btnContinue.style.border='0';
        btnContinue.style.borderRadius='8px';
        btnContinue.style.background='#32424c';
        btnContinue.style.color='white';
        btnContinue.style.cursor='pointer';
        btnContinue.style.width='100%';

        const btnCancel=document.createElement('button');
        btnCancel.textContent='Ø¥Ù„ØºØ§Ø¡';
        btnCancel.style.margin='6px';
        btnCancel.style.padding='10px 12px';
        btnCancel.style.border='0';
        btnCancel.style.borderRadius='8px';
        btnCancel.style.background='#402b2b';
        btnCancel.style.color='white';
        btnCancel.style.cursor='pointer';
        btnCancel.style.width='100%';

        box.appendChild(btnReset);
        box.appendChild(btnContinue);
        box.appendChild(btnCancel);
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        function cleanup(){ try{ document.body.removeChild(overlay); }catch{} }

        btnReset.onclick=()=>{
          cleanup();
          // reset then start with current selectors
          stop(); count=0; remainderMs=0; lastAccountedMs=null; updateLabel(); drawProgress(0);
          intervalSec=Math.min(10,Math.max(1,parseInt($interval.value||'1',10)));
          limit=Math.max(0,parseInt($limit.value||'0',10)||0);
          running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA(); if(!rafId) rafId=requestAnimationFrame(loop);
        };
        btnContinue.onclick=()=>{
          cleanup();
          // continue beyond limit
          limit=0; if($limit) $limit.value='0'; refreshETA();
          running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA(); if(!rafId) rafId=requestAnimationFrame(loop);
        };
        btnCancel.onclick=()=>{ cleanup(); /* do nothing */ };

        return; // wait for user choice
      }

      // normal start
      running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA();
      if(!rafId) rafId=requestAnimationFrame(loop);
    }

    function stop(){ running=false; if(rafId) cancelAnimationFrame(rafId); rafId=null; $start.classList.remove('active'); lastAccountedMs=null; }
    function reset(){ stop(); count=0; remainderMs=0; lastAccountedMs=null; updateLabel(); drawProgress(0); refreshETA(); }

    // bind buttons
    $start && $start.addEventListener('click', start);
    $stop && $stop.addEventListener('click', stop);
    $reset && $reset.addEventListener('click', reset);

    // inputs
    $interval && $interval.addEventListener('change', ()=>{ intervalSec=Math.min(10,Math.max(1,parseInt($interval.value||'1',10))); refreshETA(); });
    $limit && $limit.addEventListener('change', ()=>{ limit=Math.max(0,parseInt($limit.value||'0',10)||0); if(limit>0&&count>=limit) stop(); refreshETA(); });

    // presets
    let selectedPreset=null;
    function clearPresetHighlights(){
      document.querySelectorAll('#customPresets button, #presetA, #preset1, #preset2').forEach(b=>b.classList.remove('active'));
    }
    function selectPreset(b){ clearPresetHighlights(); b.classList.add('active'); selectedPreset=b; }
    function deselectPreset(b){ b.classList.remove('active'); if(selectedPreset===b) selectedPreset=null; }
    function onPresetClick(b,iv,lim){
      if(selectedPreset===b){ deselectPreset(b); return; }
      if(count>0){ const r=confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ\nÙ…ÙˆØ§ÙÙ‚ = ØªØµÙÙŠØ± / Ø¥Ù„ØºØ§Ø¡ = Ù…ØªØ§Ø¨Ø¹Ø©'); if(r) reset(); else if(lim>0 && count>=lim) lim=0; }
      $interval.value=String(iv); $limit.value=String(lim); intervalSec=iv; limit=lim; selectPreset(b); refreshETA();
    }
    $presetA && $presetA.addEventListener('click', ()=>onPresetClick($presetA,1,100));
    $preset1 && $preset1.addEventListener('click', ()=>onPresetClick($preset1,3,100));
    $preset2 && $preset2.addEventListener('click', ()=>onPresetClick($preset2,4,100));

    // local custom presets
    const LS_KEY='counter.customPresets.v1';
    function loadCustomPresets(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||[] } catch { return [] } }
    function saveCustomPresets(l){ localStorage.setItem(LS_KEY,JSON.stringify(l)); }
    let customPresets=loadCustomPresets();
    function renderCustomPresets(){
      customWrap.innerHTML='';
      customPresets.forEach(p=>{
        const b=document.createElement('button'); b.type='button'; b.className='preset-btn'; b.textContent=p.label;
        b.addEventListener('click',()=>onPresetClick(b,p.interval,p.limit));
        const del=document.createElement('span'); del.textContent=' ğŸ—‘'; del.style.cursor='pointer';
        del.addEventListener('click',e=>{
          e.stopPropagation();
          if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠÙ…Ø¬ØŸ')){
            customPresets=customPresets.filter(x=>x.id!==p.id);
            saveCustomPresets(customPresets); renderCustomPresets();
          }
        });
        b.appendChild(del); customWrap.appendChild(b);
      });
    }

    // add-preset dialog
    const addBtn=document.getElementById('addPresetBtn');
    const dlg=document.getElementById('cpDialog');
    const saveBtn=document.getElementById('cpSave');
    const cancelBtn=document.getElementById('cpCancel');
    addBtn && addBtn.addEventListener('click', ()=>{ try{ dlg.showModal(); }catch{ dlg.setAttribute('open',''); } });
    cancelBtn && cancelBtn.addEventListener('click', ()=>{ try{ dlg.close(); }catch{ dlg.removeAttribute('open'); } });
    saveBtn && saveBtn.addEventListener('click', ()=>{
      const label=document.getElementById('cpLabel').value.trim();
      const iv=Math.min(10,Math.max(1,parseInt(document.getElementById('cpInterval').value,10)||1));
      const lim=Math.max(0,parseInt(document.getElementById('cpLimit').value,10)||0);
      if(!label){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ'); return; }
      customPresets.push({id:Date.now(),label,interval:iv,limit:lim});
      saveCustomPresets(customPresets); renderCustomPresets();
      try{ dlg.close(); }catch{ dlg.removeAttribute('open'); }
      refreshETA();
    });

    // resume loop after tab returns
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && running && !rafId) rafId=requestAnimationFrame(loop); });

    // init
    (function init(){ updateLabel(); drawProgress(0); $interval.value='3'; $limit.value='100'; renderCustomPresets(); refreshETA(); })();
  </script>
</body>
</html>
