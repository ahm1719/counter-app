<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ø¹Ø¯Ø§Ø¯</title>
  <style>
    :root { --bg:#0b0c10; --card:#1f232b; --text:#e6edf3; --muted:#9aa4b2; --track:#2e3440; --ring:#3ea6ff; --danger:#ff6b6b }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;place-items:center}
    .app{width:min(560px,92vw);padding:20px;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .title{margin:0 0 12px;font-weight:700;letter-spacing:.2px;font-size:clamp(18px,2.6vw,22px);text-align:center}

    .ring-wrap{position:relative;width:220px;height:220px;margin:6px auto 8px}
    .count{position:absolute;inset:0;display:grid;place-items:center;font-size:48px;font-weight:800}
    .eta{margin:-2px auto 10px;text-align:center;font-size:14px;color:var(--muted)}

    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0 8px}
    .controls.preset{grid-template-columns:1fr;gap:10px}
    button{appearance:none;border:0;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;background:#2b313c;color:var(--text);transition:transform .04s ease,background .2s ease}
    button:active{transform:translateY(1px)}
    .start{background:#213445}.stop{background:#402b2b}.reset{background:#2b3b2c}
    .preset-btn{background:#32424c; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .preset-title{flex:1}
    .icon-btn{font-size:14px; padding:6px 8px; border-radius:8px; background:#2b313c}
    .preset-btn.active{outline:2px solid var(--ring);background:#2a3a44}
    .start.active{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(62,166,255,.25) inset}

    .rows{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px}
    .field{background:#2b313c;padding:10px 12px;border-radius:12px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .limit-row{display:flex; align-items:center; gap:10px}
    .limit-row input[type=range]{flex:1}
    .nudge{width:36px; height:36px; border-radius:8px; border:none; background:#2b313c; color:#e6edf3; cursor:pointer; font-size:18px; line-height:1}
    .limit-help{margin-top:6px; font-size:12px; color:var(--muted); text-align:center}

    dialog{background:#1f232b;border:none;border-radius:10px;padding:20px;color:#e6edf3}
    dialog input,dialog select{width:100%;margin-bottom:10px;padding:8px;border-radius:8px;border:1px solid #39414f;background:#222730;color:#e6edf3}
    menu{display:flex;gap:10px;justify-content:flex-end}

    #err{position:fixed;inset:auto 8px 8px 8px;background:#2b1f20;color:#ffd7d7;border:1px solid #5a2b2e;padding:10px 12px;border-radius:10px;display:none;z-index:9999}
    #err b{color:#ffb3b3}
  </style>
</head>
<body>
  <main class="app" role="application" aria-label="Ø¹Ø¯Ø§Ø¯ Ø¨Ø³ÙŠØ·">
    <h1 class="title">Ø§Ù„Ø¹Ø¯Ø§Ø¯</h1>

    <div class="ring-wrap" aria-live="polite" aria-atomic="true">
      <svg width="220" height="220" viewBox="0 0 220 220" aria-hidden="true">
        <circle cx="110" cy="110" r="96" stroke="var(--track)" stroke-width="12" fill="none"></circle>
        <circle id="prog" cx="110" cy="110" r="96" stroke="var(--ring)" stroke-width="12" fill="none"
                stroke-linecap="round" transform="rotate(-90 110 110)" stroke-dasharray="603.185" stroke-dashoffset="603.185"></circle>
      </svg>
      <div class="count"><span id="count">0</span></div>
    </div>
    <div class="eta">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="etaText">â€”</span></div>

    <div class="controls">
      <button class="start" id="startBtn">Ø¨Ø¯Ø¡</button>
      <button class="stop" id="stopBtn">Ø¥ÙŠÙ‚Ø§Ù</button>
      <button class="reset" id="resetBtn">ØªØµÙ€ÙÙŠØ±</button>
    </div>

    <div class="rows">
      <div class="field">
        <label for="interval">Ø§Ù„ÙØ§ØµÙ„ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ</label>
        <select id="interval">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
      </div>

      <div class="field">
        <label for="limit">Ø§Ù„Ø­Ø¯ (0 = Ø¨Ø¯ÙˆÙ† Ø­Ø¯)</label>
        <div class="limit-row">
          <button class="nudge" id="limitDown" aria-label="Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ø­Ø¯">âˆ’</button>
          <input id="limit" type="range" min="0" max="100" step="1" value="100" aria-label="Ø§Ù„Ø­Ø¯" />
          <button class="nudge" id="limitUp" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯">+</button>
        </div>
        <div class="limit-help">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="limitVal">100</span></div>
      </div>
    </div>

    <div class="controls preset" id="customPresets"></div>
    <button class="preset-btn" id="addPresetBtn">Ø¥Ø¶Ø§ÙØ©</button>

    <div class="controls preset" style="margin-top:12px">
      <button class="preset-btn" id="presetA"><span class="preset-title">Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ Ùˆ Ø¨Ø­Ù…Ø¯Ù‡</span></button>
      <button class="preset-btn" id="preset1"><span class="preset-title">Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†Øª Ø³Ø¨Ø­Ø§Ù†Ùƒ Ø¥Ù†ÙŠ ÙƒÙ†Øª Ù…Ù† Ø§Ù„Ø¸Ø§Ù„Ù…ÙŠÙ†</span></button>
      <button class="preset-btn" id="preset2"><span class="preset-title">Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±</span></button>
    </div>
  </main>

  <!-- Add/Edit Custom Preset Dialog -->
  <dialog id="cpDialog">
    <form method="dialog" id="cpForm">
      <label>Ø§Ù„Ù†Øµ
        <input id="cpLabel" type="text" required>
      </label>
      <label>Ø§Ù„ÙØ§ØµÙ„
        <select id="cpInterval"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
      </label>
      <label>Ø§Ù„Ø­Ø¯ (0 = Ø¨Ø¯ÙˆÙ† Ø­Ø¯)
        <input id="cpLimit" type="range" min="0" max="100" step="1" value="100">
        <div class="limit-help">Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="cpLimitVal">100</span></div>
      </label>
      <menu>
        <button id="cpCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="cpSave">Ø­ÙØ¸</button>
      </menu>
    </form>
  </dialog>

  <div id="err"></div>

  <script>
    'use strict';

    // Error banner
    (function(){
      const $e = document.getElementById('err');
      window.addEventListener('error', (ev)=>{
        if(!$e) return;
        $e.style.display='block';
        $e.innerHTML = '<b>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª:</b> ' + (ev.message||'') +
                       (ev.filename? ' <small>(' + ev.filename.split('/').pop() + ':' + ev.lineno + ')</small>' : '');
        console.error(ev.error||ev.message);
      });
    })();

    // --- State ---
    let running=false, count=0, intervalSec=3, limit=100, lastAccountedMs=null, remainderMs=0;

    // Elements
    const $count = document.getElementById('count');
    const $prog = document.getElementById('prog');
    const $interval = document.getElementById('interval');
    const $limit = document.getElementById('limit');       // range slider
    const $limitVal = document.getElementById('limitVal'); // text display (below)
    const $limitDown = document.getElementById('limitDown');
    const $limitUp = document.getElementById('limitUp');
    const $start = document.getElementById('startBtn');
    const $stop = document.getElementById('stopBtn');
    const $reset = document.getElementById('resetBtn');
    const $presetA = document.getElementById('presetA');
    const $preset1 = document.getElementById('preset1');
    const $preset2 = document.getElementById('preset2');
    const $eta = document.getElementById('etaText');
    const customWrap = document.getElementById('customPresets');

    // Ring helpers
    const C = 2*Math.PI*96; $prog.setAttribute('stroke-dasharray', String(C));
    function drawProgress(f){ const o=C*(1-Math.max(0,Math.min(1,f))); $prog.setAttribute('stroke-dashoffset', String(o)); }
    function updateLabel(){ $count.textContent = String(count); }

    // ETA helpers
    function formatDuration(ms){
      if(ms==null) return 'Ø¨Ø¯ÙˆÙ† Ø­Ø¯';
      let total=Math.max(0,Math.round(ms/1000));
      const h=Math.floor(total/3600); total%=3600;
      const m=Math.floor(total/60); const s=total%60;
      if(h>0) return `${h} Ø³ ${m} Ø¯`;
      if(m>0 && s===0) return `${m} Ø¯`;
      if(m>0) return `${m} Ø¯ ${s} Ø«`;
      return `${s} Ø«`;
    }
    function computeRemainingMs(){
      if (limit <= 0) return null;
      const iv = intervalSec * 1000;
      const remainingTicks = Math.max(0, limit - count);
      let ms = remainingTicks * iv - remainderMs;
      return Math.max(0, ms);
    }
    function refreshETA(){ const ms=computeRemainingMs(); $eta.textContent = formatDuration(ms); }

    // Main loop
    let rafId=null;
    function loop(){
      if(!running){ rafId=null; return; }
      const n=Date.now(); if(lastAccountedMs==null) lastAccountedMs=n;
      let d=n-lastAccountedMs; if(d<0) d=0; lastAccountedMs=n;

      const iv=intervalSec*1000; remainderMs+=d;
      const t=Math.floor(remainderMs/iv); remainderMs%=iv;

      if(t>0){
        if(limit>0){
          const remaining=Math.max(0,limit-count);
          const applied=Math.min(remaining,t);
          count+=applied;
          if(count>=limit){
            running=false; remainderMs=0; drawProgress(0); updateLabel(); refreshETA();
            $start.classList.remove('active');
            if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
            alert(`ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯: ${limit}`);
            return;
          }
        } else {
          count+=t;
        }
        updateLabel();
      }
      drawProgress(remainderMs/iv);
      refreshETA();
      rafId=requestAnimationFrame(loop);
    }

    // Controls
    function start(){
      if(running) return;
      if(rafId){ cancelAnimationFrame(rafId); rafId=null; }

      intervalSec = Math.min(10, Math.max(1, parseInt($interval.value || '1', 10)));
      limit = Math.max(0, parseInt($limit.value || '0', 10) || 0);

      // Case A: limit already reached -> Reset / Continue without limit / Cancel
      if(limit>0 && count>=limit){
        showModal([
          {text:'ØªØµÙÙŠØ± ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯', style:'#213445', action:()=>{
            stop(); count=0; remainderMs=0; lastAccountedMs=null; updateLabel(); drawProgress(0);
            intervalSec = Math.min(10, Math.max(1, parseInt($interval.value || '1', 10)));
            limit = Math.max(0, parseInt($limit.value || '0', 10) || 0);
            running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA();
            rafId=requestAnimationFrame(loop);
          }},
          {text:'Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø¯', style:'#32424c', action:()=>{
            limit=0; $limit.value='0'; updateLimitLabel(); refreshETA();
            running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA();
            rafId=requestAnimationFrame(loop);
          }},
          {text:'Ø¥Ù„ØºØ§Ø¡', style:'#402b2b', action:()=>{}}
        ], 'Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯');
        return;
      }

      // Case B: count > 0 (not at limit) -> Reset / Continue / Cancel
      if(count>0){
        showModal([
          {text:'ØªØµÙÙŠØ± ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯', style:'#213445', action:()=>{
            stop(); count=0; remainderMs=0; lastAccountedMs=null; updateLabel(); drawProgress(0);
            running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA();
            rafId=requestAnimationFrame(loop);
          }},
          {text:'Ù…ØªØ§Ø¨Ø¹Ø©', style:'#32424c', action:()=>{
            running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA();
            rafId=requestAnimationFrame(loop);
          }},
          {text:'Ø¥Ù„ØºØ§Ø¡', style:'#402b2b', action:()=>{}}
        ], 'Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ');
        return;
      }

      // Normal start
      running=true; $start.classList.add('active'); lastAccountedMs=Date.now(); refreshETA();
      rafId=requestAnimationFrame(loop);
    }

    function stop(){ running=false; if(rafId) cancelAnimationFrame(rafId); rafId=null; $start.classList.remove('active'); lastAccountedMs=null; }
    function reset(){ stop(); count=0; remainderMs=0; lastAccountedMs=null; updateLabel(); drawProgress(0); refreshETA(); }

    $start.addEventListener('click', start);
    $stop.addEventListener('click', stop);
    $reset.addEventListener('click', reset);

    // Reusable modal
    function showModal(buttons, message){
      const overlay=document.createElement('div');
      overlay.style.position='fixed'; overlay.style.inset='0';
      overlay.style.background='rgba(0,0,0,0.6)'; overlay.style.display='grid';
      overlay.style.placeItems='center'; overlay.style.zIndex='10000';

      const box=document.createElement('div');
      box.style.background='#1f232b'; box.style.padding='20px';
      box.style.borderRadius='12px'; box.style.textAlign='center';
      box.style.color='white'; box.style.width='min(340px,90vw)';
      box.innerHTML=`<p style="margin-bottom:14px;font-size:15px">${message||''}</p>`;

      buttons.forEach(b=>{
        const el=document.createElement('button');
        el.textContent=b.text;
        Object.assign(el.style,{margin:'6px',padding:'10px 12px',border:'0',borderRadius:'8px',background:b.style||'#32424c',color:'white',cursor:'pointer',width:'100%'});
        el.onclick=()=>{ try{ document.body.removeChild(overlay);}catch{}; b.action&&b.action(); };
        box.appendChild(el);
      });

      overlay.appendChild(box);
      document.body.appendChild(overlay);
    }

    // Limit slider + precise nudges
    function clamp(v){ return Math.min(100, Math.max(0, v|0)); }
    function updateLimitLabel(){
      const v = parseInt($limit.value,10)||0;
      $limitVal.textContent = (v===0 ? 'Ø¨Ø¯ÙˆÙ† Ø­Ø¯' : String(v));
    }
    function applyLimitFromUI(){
      limit = Math.max(0, parseInt($limit.value||'0', 10) || 0);
      if(limit>0 && count>=limit) stop();
      refreshETA();
    }
    $limit.addEventListener('input', updateLimitLabel);
    $limit.addEventListener('change', applyLimitFromUI);
    $limitDown.addEventListener('click', ()=>{
      $limit.value = String(clamp((parseInt($limit.value,10)||0) - 1));
      updateLimitLabel(); applyLimitFromUI();
    });
    $limitUp.addEventListener('click', ()=>{
      $limit.value = String(clamp((parseInt($limit.value,10)||0) + 1));
      updateLimitLabel(); applyLimitFromUI();
    });

    // Interval select
    $interval.addEventListener('change', ()=>{
      intervalSec=Math.min(10,Math.max(1,parseInt($interval.value||'1',10)));
      refreshETA();
    });

    // Presets (no promptâ€”just apply)
    let selectedPreset=null;
    function clearPresetHighlights(){
      document.querySelectorAll('#customPresets .preset-btn, #presetA, #preset1, #preset2').forEach(b=>b.classList.remove('active'));
    }
    function selectPreset(b){ clearPresetHighlights(); b.classList.add('active'); selectedPreset=b; }
    function deselectPreset(b){ b.classList.remove('active'); if(selectedPreset===b) selectedPreset=null; }

    function onPresetClick(b, iv, lim){
      if(selectedPreset===b){ deselectPreset(b); return; }
      $interval.value=String(iv); intervalSec=iv;
      $limit.value=String(clamp(lim)); updateLimitLabel(); limit=clamp(lim);
      selectPreset(b);
      refreshETA();
    }
    $presetA.addEventListener('click', ()=>onPresetClick($presetA,1,100));
    $preset1.addEventListener('click', ()=>onPresetClick($preset1,3,100));
    $preset2.addEventListener('click', ()=>onPresetClick($preset2,4,100));

    // Custom presets (localStorage) with EDIT support
    const LS_KEY='counter.customPresets.v1';
    function loadCustomPresets(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||[] } catch { return [] } }
    function saveCustomPresets(l){ localStorage.setItem(LS_KEY, JSON.stringify(l)); }
    let customPresets=loadCustomPresets();

    function renderCustomPresets(){
      customWrap.innerHTML='';
      customPresets.forEach(p=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='preset-btn';

        const title=document.createElement('span');
        title.className='preset-title';
        title.textContent=p.label;

        const edit=document.createElement('button');
        edit.type='button'; edit.className='icon-btn'; edit.title='ØªØ¹Ø¯ÙŠÙ„'; edit.textContent='âœï¸';
        edit.addEventListener('click', (e)=>{
          e.stopPropagation();
          openPresetDialog('edit', p);
        });

        const del=document.createElement('button');
        del.type='button'; del.className='icon-btn'; del.title='Ø­Ø°Ù'; del.textContent='ğŸ—‘';
        del.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠÙ…Ø¬ØŸ')){
            customPresets = customPresets.filter(x=>x.id!==p.id);
            saveCustomPresets(customPresets);
            renderCustomPresets();
          }
        });

        btn.addEventListener('click', ()=>onPresetClick(btn, p.interval, p.limit));

        btn.appendChild(title);
        const right=document.createElement('span');
        right.style.display='flex'; right.style.gap='6px';
        right.appendChild(edit); right.appendChild(del);
        btn.appendChild(right);

        customWrap.appendChild(btn);
      });
    }

    // Add/Edit dialog
    const addBtn=document.getElementById('addPresetBtn');
    const dlg=document.getElementById('cpDialog');
    const cpForm=document.getElementById('cpForm');
    const saveBtn=document.getElementById('cpSave');
    const cancelBtn=document.getElementById('cpCancel');
    const cpLabel=document.getElementById('cpLabel');
    const cpInterval=document.getElementById('cpInterval');
    const cpLimit=document.getElementById('cpLimit');
    const cpLimitVal=document.getElementById('cpLimitVal');

    let editingId=null; // null => add, otherwise edit existing id

    function openPresetDialog(mode, preset){
      editingId = (mode==='edit' && preset) ? preset.id : null;
      cpLabel.value = preset ? preset.label : '';
      cpInterval.value = String(preset ? preset.interval : (parseInt($interval.value,10)||3));
      cpLimit.value = String(preset ? Math.min(100, Math.max(0, preset.limit)) : Math.min(100, Math.max(0, parseInt($limit.value,10)||100)));
      cpLimitVal.textContent = (parseInt(cpLimit.value,10)===0 ? 'Ø¨Ø¯ÙˆÙ† Ø­Ø¯' : cpLimit.value);
      try { dlg.showModal(); } catch { dlg.setAttribute('open',''); }
    }

    cpLimit.addEventListener('input', ()=>{ cpLimitVal.textContent = (parseInt(cpLimit.value,10)===0 ? 'Ø¨Ø¯ÙˆÙ† Ø­Ø¯' : cpLimit.value); });

    addBtn.addEventListener('click', ()=> openPresetDialog('add'));

    cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ dlg.close(); }catch{ dlg.removeAttribute('open'); } });

    saveBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      if(!cpLabel.value.trim()){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ'); return; }
      const iv=Math.min(10,Math.max(1,parseInt(cpInterval.value,10)||1));
      const lim=Math.min(100,Math.max(0,parseInt(cpLimit.value,10)||0));
      if(editingId==null){
        customPresets.push({ id: Date.now(), label: cpLabel.value.trim(), interval: iv, limit: lim });
      } else {
        customPresets = customPresets.map(p => p.id===editingId ? {...p, label:cpLabel.value.trim(), interval:iv, limit:lim} : p);
      }
      saveCustomPresets(customPresets);
      renderCustomPresets();
      try{ dlg.close(); }catch{ dlg.removeAttribute('open'); }
    });

    // Visibility resume
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && running && !rafId){ rafId=requestAnimationFrame(loop); } });

    // Init
    (function init(){
      updateLabel();
      drawProgress(0);
      $interval.value='3';
      $limit.value='100'; updateLimitLabel();
      renderCustomPresets();
      refreshETA();
    })();
  </script>
</body>
</html>
