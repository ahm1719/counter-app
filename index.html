<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basic Counter</title>
  <style>
    :root {
      --bg: #0b0c10;       --card: #1f232b;   --text: #e6edf3;
      --muted: #9aa4b2;    --track: #2e3440;  --ring: #3ea6ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;place-items:center}
    .app{width:min(520px,92vw);padding:20px;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .title{margin:0 0 16px;font-weight:700;letter-spacing:.2px;font-size:clamp(18px,2.6vw,22px)}

    .ring-wrap{position:relative;width:220px;height:220px;margin:8px auto 18px}
    .count{position:absolute;inset:0;display:grid;place-items:center;font-size:48px;font-weight:800}

    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0 8px}
    button{appearance:none;border:0;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;background:#2b313c;color:var(--text);transition:transform .04s ease,background .2s ease}
    button:active{transform:translateY(1px)}
    .start{background:#213445}.stop{background:#402b2b}.reset{background:#2b3b2c}

    .rows{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px}
    .field{background:#2b313c;padding:10px 12px;border-radius:12px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #39414f;background:#222730;color:var(--text);font-size:16px}
    .note{text-align:center;margin-top:10px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <main class="app" role="application" aria-label="Basic Counter">
    <h1 class="title">Basic Counter</h1>

    <!-- Progress ring -->
    <div class="ring-wrap" aria-live="polite" aria-atomic="true">
      <svg width="220" height="220" viewBox="0 0 220 220" aria-hidden="true">
        <circle cx="110" cy="110" r="96" stroke="var(--track)" stroke-width="12" fill="none"></circle>
        <circle id="prog" cx="110" cy="110" r="96" stroke="var(--ring)" stroke-width="12" fill="none"
                stroke-linecap="round" transform="rotate(-90 110 110)" stroke-dasharray="603.185" stroke-dashoffset="603.185"></circle>
      </svg>
      <div class="count"><span id="count">0</span></div>
    </div>

    <div class="controls">
      <button class="start" id="startBtn">Start</button>
      <button class="stop" id="stopBtn">Stop</button>
      <button class="reset" id="resetBtn">Reset</button>
    </div>

    <div class="rows">
      <div class="field">
        <label for="interval">Interval (seconds)</label>
        <select id="interval">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option selected>10</option>
        </select>
      </div>
      <div class="field">
        <label for="limit">Limit (0 = no limit)</label>
        <select id="limit">
          <option value="0">0 (No limit)</option>
          <option>10</option><option>20</option><option>30</option><option>40</option><option>50</option>
          <option>60</option><option>70</option><option>80</option><option>90</option><option>100</option>
          <option>110</option><option>120</option>
        </select>
      </div>
    </div>

    <p class="note">Ring restored. Catchâ€‘up fixed: no extra counts on resume.</p>
  </main>

  <script>
    // =====================
    // Robust timer with ring
    // =====================
    let running = false;
    let count = 0;
    let intervalSec = 10; // UI default
    let limit = 0;        // 0 = no limit

    // Time accounting
    let lastAccountedMs = null; // last time the loop accounted for time
    let remainderMs = 0;        // leftover within current interval (ms)

    // DOM
    const $count = document.getElementById('count');
    const $prog  = document.getElementById('prog');
    const $interval = document.getElementById('interval');
    const $limit = document.getElementById('limit');
    const $start = document.getElementById('startBtn');
    const $stop  = document.getElementById('stopBtn');
    const $reset = document.getElementById('resetBtn');

    const C = 2 * Math.PI * 96; // circumference of r=96
    $prog.setAttribute('stroke-dasharray', String(C));

    function drawProgress(frac){
      const clamped = Math.max(0, Math.min(1, frac));
      const offset = C * (1 - clamped);
      $prog.setAttribute('stroke-dashoffset', String(offset));
    }
    function updateLabel(){ $count.textContent = String(count); }

    // Main loop using rAF; adds ticks based on elapsed real time.
    let rafId = null;
    function loop(){
      if (!running) { rafId = null; return; }
      const now = Date.now();
      if (lastAccountedMs == null) lastAccountedMs = now;
      let delta = now - lastAccountedMs; if (delta < 0) delta = 0;
      lastAccountedMs = now;

      const ivMs = intervalSec * 1000;
      remainderMs += delta;
      const ticks = Math.floor(remainderMs / ivMs);
      remainderMs = remainderMs % ivMs;

      if (ticks > 0){
        // apply ticks but do not overshoot limit
        if (limit > 0){
          const remaining = Math.max(0, limit - count);
          const applied = Math.min(remaining, ticks);
          count += applied;
          if (count >= limit){
            running = false;
            remainderMs = 0;
            drawProgress(0);
            updateLabel();
            alert(`Reached limit: ${limit}`);
            return; // stop loop
          }
        } else {
          count += ticks;
        }
        updateLabel();
      }

      drawProgress(remainderMs / ivMs);
      rafId = requestAnimationFrame(loop);
    }

    function start(){
      if (running) return;
      intervalSec = Math.min(10, Math.max(1, parseInt($interval.value || '1', 10)));
      limit = Math.max(0, parseInt($limit.value || '0', 10) || 0);
      if (limit > 0 && count >= limit){ alert('Already at the limit. Reset or increase the limit.'); return; }
      running = true;
      if (lastAccountedMs == null) lastAccountedMs = Date.now();
      if (!rafId) rafId = requestAnimationFrame(loop);
    }
    function stop(){ running = false; if (rafId) cancelAnimationFrame(rafId); rafId = null; }
    function reset(){ stop(); count = 0; remainderMs = 0; lastAccountedMs = null; updateLabel(); drawProgress(0); }

    $start.addEventListener('click', start);
    $stop.addEventListener('click', stop);
    $reset.addEventListener('click', reset);

    // Keep counts correct on return WITHOUT double-adding: we don't add here, we let loop account via delta.
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible'){
        // if loop was paused by the browser, resume scheduling only
        if (running && !rafId) rafId = requestAnimationFrame(loop);
      } else {
        // do nothing; lastAccountedMs remains at the last frame time so delta includes time away
      }
    });

    // Init
    (function init(){
      updateLabel();
      drawProgress(0);
      // reflect defaults
      $interval.value = '10';
      $limit.value = '0';
    })();
  </script>
</body>
</html>
